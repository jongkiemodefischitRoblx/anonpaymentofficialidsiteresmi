<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pembayaran QRIS</title>
<link href="style.css" rel="stylesheet">
</head>
<body>

<div class="box">
    <h2>Pembayaran QRIS</h2>

    <img id="qrimg" class="qr" alt="QRIS">

    <div class="detail">
       <b>Detail Transaksi:</b><br>
       Invoice : <span id="inv"></span><br>
       Nominal : Rp <span id="amt"></span><br>
       Metode  : QRIS Auto<br>
       Status  : <span id="sts">MEMPROSES...</span><br>
       Expired : <span id="timer">10:00</span>
    </div>

    <button onclick="checkStatus()">Cek Status</button>
</div>

<script>
const SLUG = "anon-payment";
const APIKEY = "lPOX2W6MqhFETsfkvVwfBTjDNUlsj1xK";
const q = new URLSearchParams(location.search);
const id = q.get("id");
const amount = q.get("amount");

document.getElementById("inv").innerText = id;
document.getElementById("amt").innerText = amount;

// QRIS real-time dari Pakasir
document.getElementById("qrimg").src = `https://api.pakasir.com/${SLUG}/qris/${id}.png?apikey=${APIKEY}`;

// Timer persistent
const TIMER_KEY = `invoice_timer_${id}`;
let expireTime = localStorage.getItem(TIMER_KEY);
if(!expireTime){ expireTime = Date.now() + 10*60*1000; localStorage.setItem(TIMER_KEY, expireTime); }

function updateTimer(){
    const now = Date.now();
    let t = Math.floor((expireTime-now)/1000);
    if(t<=0){ 
        t=0; 
        document.getElementById("timer").innerText="00:00"; 
        clearInterval(timerInterval); 
        localStorage.removeItem(TIMER_KEY); 
        document.getElementById("sts").innerText="EXPIRED"; 
        return; 
    }
    let m=Math.floor(t/60),s=t%60;
    document.getElementById("timer").innerText=`${m}:${s<10?'0'+s:s}`;
}
const timerInterval=setInterval(updateTimer,1000);
updateTimer();

// Status auto-check
async function checkStatus(){
    try{
        const res = await fetch(`https://api.pakasir.com/${SLUG}/qris/status?id=${id}`, {
            headers: {"apikey": APIKEY}
        });
        const data = await res.json();
        let status = data.status || "MEMPROSES";
        document.getElementById("sts").innerText = status;
        if(status==="PAID" || status==="SUCCESS"){
            localStorage.removeItem(TIMER_KEY);
            window.location = `success.html?id=${id}&amount=${amount}`;
        }
    }catch(e){ 
        console.error(e); 
        document.getElementById("sts").innerText="ERROR"; 
    }
}
setInterval(checkStatus,5000);
</script>
</body>
</html>
